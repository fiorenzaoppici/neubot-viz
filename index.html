<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Neubot online tool</title>
		<link rel="stylesheet" type="text/css" href="style.css" />
		<script type="text/javascript" src="js/jquery-1.8.3.js"></script>
		<script src="js/d3.js"></script>

	</head>
	<body>
	    <div id="wrapper">
	        <div id="parameters" class="wbackground">
            <div id="fields">
                <span>Start date:
                    <input id="startDate">
                    </input></span>
                <span> End date:
                    <input id="endDate">
                    </input></span>
                <select id="timebasis" class="selector">
                <option value="2" selected> days <option value="1"> hours 
                <option value="3"> months
                </select>
                <button>
                    Submit!
                </button>
            </div>
            <ul id="tabs">
                <li id="tab-3">
                    Raw Test
                </li>
                <li id="tab-2">
                    Bittorrent
                </li>
                <li id="tab-1"class="selected">
                    Speedtest
                </li>
            </ul>
        </div>
		<div id="container">
			<div id="grapharea-1" class="wbackground">
				<svg id="1"width="700" height="500">
					<g class="background">
						<rect x="20" y="20" width="660" height="460"
						fill="white"></rect>
						<text text-anchor="middle" x="60" y="210"
						transform="rotate(-90,60,230)">
							Goodput (Kbit/s)
						</text>
						<g class="legend">
							<circle class="download" r="5" cx="650" cy="40">
						
							</circle>
							<text text-anchor="middle" x="780" y="60"
							transform=" scale(0.7)">
								Download
							</text>
							<line class="download" x1="600" x2="645"
							y1="40" y2="40"></line>
							<circle class="upload" r="5" cx="650" cy="60">
							
							</circle>
							<line class="upload" x1="600" x2="645" y1="60" y2="60">
							
							</line>
							<text text-anchor="middle" x="780" y="90"
							transform=" scale(0.7)">
								Upload
							</text>
						</g>
						<g class="refresh-1" transform="translate(100,80)"></g>
					</g>
				</svg>
			</div>
			<div id="grapharea-2" class="wbackground">
				<svg id="2" width="700" height="500">
					<g class="background">
						<rect x="20" y="20" width="660" height="460"
						fill="white"></rect>
						<text text-anchor="middle" x="60" y="210"
						transform="rotate(-90,60,230)">
							Goodput (Kbit/s)
						</text>
						<g class="legend">
							<circle class="download" r="5" cx="650" cy="40">
						
							</circle>
							<text text-anchor="middle" x="780" y="60"
							transform=" scale(0.7)">
								Download
							</text>
							<line class="download" x1="600" x2="645"
							y1="40" y2="40"></line>
							<circle class="upload" r="5" cx="650" cy="60">
						
							</circle>
							<line class="upload" x1="600" x2="645" y1="60" y2="60">
							
							</line>
							<text text-anchor="middle" x="780" y="90"
							transform=" scale(0.7)">
								Upload
							</text>
						</g>
						<g class="refresh-2" transform="translate(100,80)"></g>
					</g>
				</svg>
			</div>
			<div id="grapharea-3" class="wbackground">
				<svg width="700" height="500">
					<g class="background">
						<rect x="20" y="20" width="660" height="460"
						fill="white"></rect>
						<text text-anchor="middle" x="60" y="210"
						transform="rotate(-90,60,230)">
							Goodput (Kbit/s)
						</text>
						<g class="legend">
							<circle class="download" r="5" cx="650" cy="40"></circle>
							<text text-anchor="middle" x="780" y="60"
							transform=" scale(0.7)">
								Download
							</text>
							<line class="download" x1="600" x2="645"
							y1="40" y2="40"></line>
							<circle class="upload" r="5" cx="650" cy="60">
						
							</circle>
							<line class="upload" x1="600" x2="645" y1="60" y2="60">
							
							</line>
							<text text-anchor="middle" x="780" y="90"
							transform=" scale(0.7)">
								Upload
							</text>
						</g>
						<g class="refresh-3" transform="translate(100,80)"></g>
					</g>
				</svg>
			</div>
		</div>
		      
		</div>
		<script type="text/javascript">
            jQuery('#container').addClass('js');
            jQuery("#tabs li").each(function() {
                jQuery(this).click(function() {
                    var tabId = jQuery(this).attr('id');
                    var tabId = tabId.split('-');
                    var tabContent = document.getElementById('grapharea-' + tabId[1]);
                    tabContent.style.display = 'block';
                    jQuery(this).addClass('selected');
                    jQuery(this).siblings().removeClass('selected');
                    jQuery(tabContent).siblings().css('display', 'none');
                });
            });
		</script>

	
		<script type="text/javascript" src="js/linechart_bittorrent.js"></script>
		<script type="text/javascript" src="js/linechart_speedtest.js"></script>
		<script type="text/javascript">
		      
    var submit=d3.select("button");
    var startDate=d3.select("#startDate");
    var endDate=d3.select("#endDate");
    var selector=d3.select("#timebasis");
    var defaultab = d3.select("#tab-1");
    
    format2 = d3.time.format("%Y-%m-%d").parse;
    
     
    d3.selectAll("input").property("value","");
    d3.selectAll("input").attr("class","");
    selector.property("selected",2);

    defaultab.attr("class", "selected");
    
    var checkStart = function() {
        var errorMsg = "";
        if (startDate.property("value") == "") {
            errorMsg = "Start date not specified";
        } else if ((format2(startDate.property("value"))) == null) {
            errorMsg = " Invalid date format for start date";
        } else if (format2(startDate.property("value")) != null) {
            startDate.attr("class", "");
        }
        if (errorMsg != "") {
            startDate.attr("class", "errorinput");
        }
        return errorMsg;
    };

//checks user input for the parameter "end date"
    var checkEnd = function() {
        var errorMsg = "";
        if (endDate.property("value") == "") {
            errorMsg = "End date not specified";
        } 
        else if ((format2(endDate.property("value"))) == null) {
            errorMsg = "Invalid date format for End date";
        } 
        else if (format2(endDate.property("value")) != null) {
            endDate.attr("class", "");
        }
        if (errorMsg != "") {
            endDate.attr("class", "errorinput");
        }
        return errorMsg;
    };


    d3.select("#timebasis")
        .on("change", function() {
            speedtest.setAggregationLevel(this);
            bittorrent.selectIndex(this);
            })
    
    submit.on("click", function() {
        
        var errorMessages=[];
                if(checkStart().length==0&&checkEnd().length==0){
                    if(format2(startDate.property("value"))<=
                       format2(endDate.property("value"))){
                           
                speedtest.setBeginning(startDate.property("value")+ " 00");
                speedtest.setEnding(endDate.property("value")+ " 23");
                
                bittorrent.setBeginning(startDate.property("value") + " 00");
                bittorrent.setEnding(endDate.property("value") + " 23");
                
                var bp=d3.json("data/data_speedtest_2.json", 
                                function(json){speedtest.processJson(json)});
                                
                var bt=d3.json("data/data_bittorrent_2.json", 
                                function(json){ bittorrent.callback(json)});
                }else{
                    errorMessages.push(
                        "Start date must be smaller than end date.");
                }
            }else{
              errorMessages.push(checkStart() , checkEnd())
            }
            if(errorMessages.length>0){
                showErrors(errorMessages);
            }else{
                clearErrorPane();
            }
    });
    
    var showErrors= function(errorList){
        var errorDiv;
        
        var parametersDiv = d3.select("#parameters");
        
        //just horrible way of handling it, I'll fix it as soon as possible
        if(parametersDiv.select("#errorDiv")[0][0]==null){
           errorDiv=parametersDiv.insert("div" , "#tabs")
                                 .attr("id" , "errorDiv");
           errorDiv.append("p")
                   .text("Input errors:");
        }else{
            errorDiv=parametersDiv.select("#errorDiv");
            parametersDiv.select("ul").remove()
        }
        var unorderedList = errorDiv.append("ul");
            
            for (i=0; i<errorList.length; i++){
                if(errorList[i] != ""){
                    unorderedList.append("li")
                            .attr("class" , "errorLi")
                            .text(errorList[i])
                }
            }
        
    }
    
    var clearErrorPane = function(){
        var parametersDiv = d3.select("#parameters");
        if(parametersDiv.select("#errorDiv")[0][0]!=null){
           parametersDiv.select("#errorDiv").remove();
        }
    }
    </script>
	</body>
</html>
